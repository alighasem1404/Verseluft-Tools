<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Content Compliance Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght0400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom highlight is no longer needed but kept for potential future use */
        .highlight {
            background-color: #fca5a5; /* Red-300 */
            border-radius: 4px;
            padding: 1px 3px;
        }
        /* Style for the scrollable list of issues */
        #issues-list {
            max-height: 300px;
            overflow-y: auto;
        }
        /* Style for file input label */
        .custom-file-upload {
            border: 2px dashed #d1d5db;
            padding: 2rem;
            cursor: pointer;
            text-align: center;
            border-radius: 0.5rem;
            transition: all 0.2s;
            display: block;
            background-color: #f9fafb;
        }
        .custom-file-upload:hover {
            border-color: #93c5fd; /* Blue-300 */
            background-color: #eff6ff; /* Blue-50 */
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // Set up the worker source for pdf.js to enable PDF loading
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">PDF Compliance Checker</h1>
            <p class="text-gray-600">Upload your PDF file to check it against the embedded list of prohibited terms.</p>
        </header>

        <div class="grid md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <label class="block text-lg font-semibold text-gray-800 mb-2">1. Upload PDF Document</label>
                <input type="file" id="pdf-file-input" accept=".pdf" class="hidden" onchange="updateFileName(this)">
                <label for="pdf-file-input" class="custom-file-upload">
                    <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 014 4v2a4 4 0 01-4 4h-1M6 16a4 4 0 004 4h1a4 4 0 004-4" />
                    </svg>
                    <p id="file-name" class="mt-2 text-sm font-medium text-gray-600">Click to select a PDF file</p>
                    <p class="text-xs text-gray-400">(.pdf only)</p>
                </label>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <label class="block text-lg font-semibold text-gray-800 mb-2">2. Embedded Prohibited Phrases</label>
                <p class="text-sm text-gray-500 mb-2">This list is hardcoded in the code and used for every check. (Case-Insensitive)</p>
                <div id="prohibited-phrases-display" class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 h-[280px] overflow-y-auto text-sm text-gray-700 whitespace-pre-wrap">
                    </div>
            </div>
        </div>

        <button id="check-button" onclick="checkDocument()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 transition duration-150 ease-in-out focus:outline-none focus:ring-4 focus:ring-blue-500 focus:ring-opacity-50 transform hover:scale-[1.005] mb-8" disabled>
            <span id="check-button-text">Please Select a PDF File</span>
        </button>

        <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">3. Results & Issues Found</h2>

            <div id="status-message" class="text-lg font-medium mb-4 p-3 rounded-lg hidden"></div>

            <div id="highlighted-text-preview" class="hidden"></div> <div class="mb-4">
                <p class="font-semibold text-gray-700 mb-2">List of Detected Phrases:</p>
                <div id="issues-list" class="bg-gray-100 p-4 rounded-lg border border-gray-300 text-sm">
                    No issues found yet.
                </div>
            </div>
        </section>

    </div>

    <script>
        // --- EMBEDDED PROHIBITED PHRASES ---
        // Phrases that should match regardless of word boundaries (usually multi-word phrases or specific terms)
        const EMBEDDED_PHRASES = [
            "Dungeons & Dragons", "D&D", "dnd", "Player’s Handbook", "Dungeon Master",
            "Monster Manual", "Wizards of the Coast",
            "Forgotten Realms", "Faerûn",
            "Underdark", "Red Wizard of Thay", "the City of Union", "Heroic Domains of Ysgard", 
            "Ever-Changing Chaos of Limbo", "Windswept Depths of Pandemonium", 
            "Infinite Layers of the Abyss", "Tarterian Depths of Carceri", "Gray Waste of Hades", 
            "Bleak Eternity of Gehenna", "Nine Hells of Baator", "Infernal Battlefield of Acheron", 
            "Clockwork Nirvana of Mechanus", "Peaceable Kingdoms of Arcadia", 
            "Seven Mounting Heavens of Celestia", "Twin Paradises of Bytopia", 
            "Blessed Fields of Elysium", "Wilderness of the Beastlands", 
            "Olympian Glades of Arborea", "Concordant Domain of the Outlands", 
            "Lady of Pain", "Book of Exalted Deeds", "Book of Vile Darkness", 
            "beholder", "gauth", "carrion crawler", "tanar’ri", "baatezu", "displacer beast", 
            "githyanki", "githzerai", "mind flayer", "illithid", "umber hulk", "yuan-ti"
        ];

        // NEW: Phrases that must be a whole word, but allow specific suffixes (like 's or s)
        // This is a dedicated list to handle the "DM" issue.
        const WHOLE_WORD_PHRASES = [
            "DM"
        ];
        // ------------------------------------

        // Utility function to escape regular expression special characters
        const escapeRegExp = (string) => {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        };

        /**
         * Updates the file name display and enables/disables the check button.
         * @param {HTMLInputElement} input - The file input element.
         */
        function updateFileName(input) {
            const fileNameDisplay = document.getElementById('file-name');
            const checkButton = document.getElementById('check-button');
            const checkButtonText = document.getElementById('check-button-text');

            if (input.files.length > 0) {
                fileNameDisplay.textContent = input.files[0].name;
                checkButtonText.textContent = 'Run Compliance Check';
                checkButton.disabled = false;
            } else {
                fileNameDisplay.textContent = 'Click to select a PDF file';
                checkButtonText.textContent = 'Please Select a PDF File';
                checkButton.disabled = true;
            }
        }

        /**
         * Displays the embedded phrases on load.
         */
        window.onload = function() {
            // Combine both lists for display
            const allPhrasesForDisplay = EMBEDDED_PHRASES.concat(WHOLE_WORD_PHRASES.map(p => `${p} / ${p}s / ${p}'s`));
            document.getElementById('prohibited-phrases-display').textContent = allPhrasesForDisplay.join('\n');
            updateFileName(document.getElementById('pdf-file-input'));
        }

        /**
         * Reads the PDF file, extracts text with page numbers, and runs the compliance check.
         */
        async function checkDocument() {
            const fileInput = document.getElementById('pdf-file-input');
            const file = fileInput.files[0];
            const issuesListElement = document.getElementById('issues-list');
            const statusMessageElement = document.getElementById('status-message');
            const checkButton = document.getElementById('check-button');
            const buttonTextElement = document.getElementById('check-button-text');
            
            issuesListElement.innerHTML = '';
            statusMessageElement.classList.add('hidden');

            if (!file) {
                statusMessageElement.textContent = 'Please select a PDF file first.';
                statusMessageElement.className = 'text-lg font-medium mb-4 p-3 rounded-lg bg-yellow-100 text-yellow-800';
                statusMessageElement.classList.remove('hidden');
                return;
            }

            // UI feedback while processing
            checkButton.disabled = true;
            buttonTextElement.textContent = 'Parsing PDF... Please wait (this may take a moment for large files)';
            
            let pageTextData = []; 

            try {
                // 1. Read the PDF file as an ArrayBuffer
                const arrayBuffer = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsArrayBuffer(file);
                });

                // 2. Load the PDF document
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const numPages = pdf.numPages;

                // 3. Extract text content page by page
                for (let i = 1; i <= numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    
                    const pageText = textContent.items.map(item => item.str).join(' '); 
                    
                    pageTextData.push({
                        text: pageText,
                        page: i
                    });
                }
                
                runComplianceCheckLogic(pageTextData, issuesListElement, statusMessageElement);

            } catch (error) {
                console.error("PDF processing failed:", error);
                statusMessageElement.textContent = `❌ ERROR: Failed to process PDF. Ensure the file is a valid, text-based PDF. Details: ${error.message}`;
                statusMessageElement.className = 'text-lg font-medium mb-4 p-3 rounded-lg bg-red-100 text-red-800';
                statusMessageElement.classList.remove('hidden');
            } finally {
                checkButton.disabled = false;
                buttonTextElement.textContent = 'Re-Run Compliance Check';
            }
        }

        /**
         * Core logic to check text against prohibited phrases.
         * Extracts matches and their page numbers.
         * @param {Array<{text: string, page: number}>} pageTextData - Text content and page number for each page.
         */
        function runComplianceCheckLogic(pageTextData, issuesListElement, statusMessageElement) {
            // Filter and sort general phrases
            const generalPhrases = EMBEDDED_PHRASES
                .filter(p => p.length > 0)
                .sort((a, b) => b.length - a.length);

            let issuesCount = 0;
            const issuesFound = [];
            
            // --- 1. General Phrases Check (no strict word boundary) ---
            if (generalPhrases.length > 0) {
                const generalRegexSource = generalPhrases.map(escapeRegExp).join('|');
                const generalDetectionRegex = new RegExp(`(${generalRegexSource})`, 'gi');
                
                pageTextData.forEach(pageData => {
                    const pageNumber = pageData.page;
                    const pageText = pageData.text;

                    let match;
                    // Reset the regex index for each page
                    generalDetectionRegex.lastIndex = 0; 
                    while ((match = generalDetectionRegex.exec(pageText)) !== null) {
                        issuesCount++;
                        issuesFound.push({
                            phrase: match[0],
                            page: pageNumber,
                        });
                    }
                });
            }

            // --- 2. Whole Word Phrases Check (with word boundary and variation support) ---
            if (WHOLE_WORD_PHRASES.length > 0) {
                // Specifically for 'DM': matches DM, DMs, or DM's as a whole word, case-insensitive.
                // You can extend this logic if more terms need this specific whole-word check.
                const dmRegex = new RegExp(`\\bDM('s|s)?\\b`, 'gi'); 
                
                pageTextData.forEach(pageData => {
                    const pageNumber = pageData.page;
                    const pageText = pageData.text;

                    let match;
                    dmRegex.lastIndex = 0; 
                    while ((match = dmRegex.exec(pageText)) !== null) {
                        issuesCount++;
                        issuesFound.push({
                            phrase: match[0], // Will be "DM", "DMs", or "DM's"
                            page: pageNumber,
                        });
                    }
                });
            }


            // Update UI
            if (issuesCount === 0) {
                statusMessageElement.textContent = '✅ SUCCESS! No prohibited phrases were found in your document.';
                statusMessageElement.className = 'text-lg font-medium mb-4 p-3 rounded-lg bg-green-100 text-green-800';
                issuesListElement.innerHTML = '<p class="text-green-600 font-semibold">The document is clean! You are ready to publish.</p>';
            } else {
                statusMessageElement.textContent = `⚠️ ATTENTION: ${issuesCount} total issue(s) found. Review the list below.`;
                statusMessageElement.className = 'text-lg font-medium mb-4 p-3 rounded-lg bg-red-100 text-red-800';

                // Sort issues by page number for easier review
                issuesFound.sort((a, b) => a.page - b.page);

                const listItems = issuesFound.map(issue => {
                    return `<li class="border-b border-gray-200 py-2 last:border-b-0">
                        <span class="font-bold text-gray-900 mr-2">Page ${issue.page}:</span> 
                        <span class="italic text-red-700">${issue.phrase}</span>
                    </li>`;
                }).join('');

                issuesListElement.innerHTML = `<ul class="divide-y divide-gray-200">${listItems}</ul>`;
            }

            statusMessageElement.classList.remove('hidden');
        }
    </script>

</body>
</html>